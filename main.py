import streamlit as st
import pandas as pd
import yfinance as yf
import numpy as np
from datetime import datetime, timedelta

# [1] í˜ì´ì§€ ë° ë ˆì´ì•„ì›ƒ ì„¤ì •
st.set_page_config(page_title="3Q SND Tier-Weight Backtester", layout="wide")
st.title("ğŸš€ 3Q í‹°ì–´ë³„ ë…ë¦½ ë§¤ë§¤ ì‹œìŠ¤í…œ (ê°œë³„ MOC/ìµì ˆ ì ìš©)")

# [2] SND ë°ì´í„° DB (2018~2026)
SND_DB = {
    "18.01.02": "D", "18.01.08": "N", "18.01.16": "D", "18.01.22": "N", "18.01.29": "D",
    "18.02.05": "D", "18.02.12": "D", "18.02.20": "S", "18.02.26": "S", "18.03.05": "N",
    "18.03.12": "S", "18.03.19": "N", "18.03.26": "D", "18.04.02": "N", "18.04.09": "N",
    "18.04.16": "N", "18.04.23": "D", "18.04.30": "D", "18.05.07": "N", "18.05.14": "S",
    "18.05.21": "S", "18.05.29": "N", "18.06.04": "N", "18.06.11": "N", "18.06.18": "D",
    "18.06.25": "D", "18.07.02": "N", "18.07.09": "S", "18.07.16": "S", "18.07.23": "N",
    "18.07.30": "S", "18.08.06": "N", "18.08.13": "D", "18.08.20": "D", "18.08.27": "S",
    "18.09.04": "S", "18.09.10": "D", "18.09.17": "N", "18.09.24": "D", "18.10.01": "N",
    "18.10.08": "S", "18.10.15": "D", "18.10.22": "S", "18.10.29": "D", "18.11.05": "S",
    "18.11.12": "D", "18.11.19": "S", "18.11.26": "D", "18.12.03": "S", "18.12.10": "D",
    "18.12.17": "S", "18.12.24": "D", "18.12.31": "S", "19.01.07": "S", "19.01.14": "S",
    "19.01.22": "N", "19.01.28": "S", "19.02.04": "S", "19.02.11": "N", "19.02.19": "S",
    "19.02.25": "N", "19.03.04": "N", "19.03.11": "D", "19.03.18": "S", "19.03.25": "D",
    "19.04.01": "S", "19.04.08": "D", "19.04.15": "S", "19.04.22": "D", "19.04.29": "D",
    "19.05.06": "D", "19.05.13": "D", "19.05.20": "D", "19.05.28": "D", "19.06.03": "D",
    "19.06.10": "S", "19.06.17": "S", "19.06.24": "N", "19.07.01": "S", "19.07.08": "S",
    "19.07.15": "N", "19.07.22": "S", "19.07.29": "S", "19.08.05": "D", "19.08.12": "D",
    "19.08.19": "N", "19.08.26": "S", "19.09.03": "S", "19.09.09": "S", "19.09.16": "D",
    "19.09.23": "D", "19.09.30": "D", "19.10.07": "N", "19.10.14": "S", "19.10.21": "N",
    "19.10.28": "S", "19.11.04": "N", "19.11.11": "S", "19.11.18": "N", "19.11.25": "D",
    "19.12.02": "N", "19.12.09": "D", "19.12.16": "N", "19.12.23": "D", "19.12.30": "N",
    "20.01.06": "D", "20.01.13": "D", "20.01.21": "D", "20.01.27": "D", "20.02.03": "D",
    "20.02.10": "N", "20.02.18": "D", "20.02.24": "D", "20.03.02": "N", "20.03.09": "D",
    "20.03.16": "D", "20.03.23": "D", "20.03.30": "S", "20.04.06": "D", "20.04.13": "S",
    "20.04.20": "N", "20.04.27": "D", "20.05.04": "D", "20.05.11": "N", "20.05.18": "D",
    "20.05.26": "N", "20.06.01": "N", "20.06.08": "S", "20.06.15": "N", "20.06.22": "S",
    "20.06.29": "N", "20.07.06": "D", "20.07.13": "N", "20.07.20": "D", "20.07.27": "D",
    "20.08.03": "D", "20.08.10": "D", "20.08.17": "D", "20.08.24": "D", "20.08.31": "D",
    "20.09.08": "D", "20.09.14": "D", "20.09.21": "S", "20.09.28": "D", "20.10.05": "S",
    "20.10.12": "D", "20.10.19": "D", "20.10.26": "D", "20.11.02": "D", "20.11.09": "N",
    "20.11.16": "D", "20.11.23": "N", "20.11.30": "D", "20.12.07": "N", "20.12.14": "D",
    "20.12.21": "N", "20.12.28": "D", "21.01.04": "N", "21.01.11": "D", "21.01.19": "D",
    "21.01.25": "D", "21.02.01": "D", "21.02.08": "D", "21.02.16": "D", "21.02.22": "D",
    "21.03.01": "D", "21.03.08": "D", "21.03.15": "N", "21.03.22": "S", "21.03.29": "N",
    "21.04.05": "N", "21.04.12": "N", "21.04.19": "D", "21.04.26": "N", "21.05.03": "N",
    "21.05.10": "S", "21.05.17": "D", "21.05.24": "D", "21.06.01": "N", "21.06.07": "S",
    "21.06.14": "S", "21.06.21": "D", "21.06.28": "S", "21.07.06": "N", "21.07.12": "N",
    "21.07.19": "D", "21.07.26": "S", "21.08.02": "S", "21.08.09": "S", "21.08.16": "D",
    "21.08.23": "N", "21.08.30": "N", "21.09.07": "D", "21.09.13": "N", "21.09.20": "N",
    "21.09.27": "N", "21.10.04": "D", "21.10.11": "D", "21.10.18": "S", "21.10.25": "S",
    "21.11.01": "N", "21.11.08": "N", "21.11.15": "D", "21.11.22": "N", "21.11.29": "D",
    "21.12.06": "D", "21.12.13": "D", "21.12.20": "D", "21.12.27": "N", "22.01.03": "D",
    "22.01.10": "N", "22.01.18": "D", "22.01.24": "D", "22.01.31": "D", "22.02.07": "S",
    "22.02.14": "D", "22.02.22": "S", "22.02.28": "D", "22.03.07": "S", "22.03.14": "D",
    "22.03.21": "S", "22.03.28": "D", "22.04.04": "D", "22.04.11": "D", "22.04.18": "S",
    "22.04.25": "D", "22.05.02": "S", "22.05.09": "D", "22.05.16": "D", "22.05.23": "S",
    "22.05.31": "S", "22.06.06": "D", "22.06.13": "S", "22.06.21": "D", "22.06.27": "S",
    "22.07.05": "D", "22.07.11": "S", "22.07.18": "S", "22.07.25": "S", "22.08.01": "N",
    "22.08.08": "S", "22.08.15": "N", "22.08.22": "D", "22.08.29": "D", "22.09.06": "D",
    "22.09.12": "D", "22.09.19": "N", "22.09.26": "N", "22.10.03": "D", "22.10.10": "N",
    "22.10.17": "D", "22.10.24": "N", "22.10.31": "D", "22.11.07": "N", "22.11.14": "S",
    "22.11.21": "D", "22.11.28": "N", "22.12.05": "N", "22.12.12": "S", "22.12.19": "D",
    "22.12.27": "N", "23.01.03": "S", "23.01.09": "S", "23.01.17": "N", "23.01.23": "S",
    "23.01.30": "D", "23.02.06": "S", "23.02.13": "D", "23.02.21": "D", "23.02.27": "N",
    "23.03.06": "N", "23.03.13": "N", "23.03.20": "S", "23.03.27": "N", "23.04.03": "S",
    "23.04.10": "D", "23.04.17": "D", "23.04.24": "D", "23.05.01": "N", "23.05.08": "N",
    "23.05.15": "D", "23.05.22": "S", "23.05.30": "S", "23.06.05": "S", "23.06.12": "D",
    "23.06.20": "S", "23.06.26": "D", "23.07.03": "S", "23.07.10": "D", "23.07.17": "N",
    "23.07.24": "D", "23.07.31": "N", "23.08.07": "D", "23.08.14": "D", "23.08.21": "N",
    "23.08.28": "N", "23.09.05": "N", "23.09.11": "N", "23.09.18": "D", "23.09.25": "D",
    "23.10.02": "N", "23.10.09": "D", "23.10.16": "N", "23.10.23": "D", "23.10.30": "N",
    "23.11.06": "S", "23.11.13": "N", "23.11.20": "S", "23.11.27": "S", "23.12.04": "N",
    "23.12.11": "N", "23.12.18": "S", "23.12.26": "N", "24.01.02": "S", "24.01.08": "D",
    "24.01.16": "S", "24.01.22": "D", "24.01.29": "S", "24.02.05": "D", "24.02.12": "S",
    "24.02.20": "D", "24.02.26": "D", "24.03.04": "D", "24.03.11": "D", "24.03.18": "D",
    "24.03.25": "D", "24.04.01": "D", "24.04.08": "D", "24.04.15": "D", "24.04.22": "D",
    "24.04.29": "S", "24.05.06": "S", "24.05.13": "S", "24.05.20": "N", "24.05.28": "S",
    "24.06.03": "N", "24.06.10": "N", "24.06.17": "S", "24.06.24": "N", "24.07.01": "D",
    "24.07.08": "N", "24.07.15": "N", "24.07.22": "D", "24.07.29": "S", "24.08.05": "D",
    "24.08.12": "N", "24.08.19": "S", "24.08.26": "N", "24.09.03": "D", "24.09.09": "D",
    "24.09.16": "D", "24.09.23": "D", "24.09.30": "N", "24.10.07": "N", "24.10.14": "D",
    "24.10.21": "D", "24.10.28": "D", "24.11.04": "D", "24.11.11": "S", "24.11.18": "D",
    "24.11.25": "D", "24.12.02": "D", "24.12.09": "N", "24.12.16": "S", "24.12.23": "D",
    "24.12.30": "N", "25.01.06": "D", "25.01.13": "D", "25.01.21": "N", "25.01.27": "S",
    "25.02.03": "D", "25.02.10": "N", "25.02.18": "D", "25.02.24": "S", "25.03.03": "D",
    "25.03.10": "D", "25.03.17": "D", "25.03.24": "D", "25.03.31": "D", "25.04.07": "D",
    "25.04.14": "S", "25.04.21": "D", "25.04.28": "S", "25.05.05": "S", "25.05.12": "S",
    "25.05.19": "N", "25.05.27": "D", "25.06.02": "N", "25.06.09": "S", "25.06.16": "S",
    "25.06.23": "S", "25.06.30": "S", "25.07.07": "N", "25.07.14": "S", "25.07.21": "D",
    "25.07.28": "S", "25.08.04": "D", "25.08.11": "S", "25.08.18": "D", "25.08.25": "D",
    "25.09.02": "D", "25.09.08": "D", "25.09.15": "D", "25.09.22": "D", "25.09.29": "D",
    "25.10.06": "D", "25.10.13": "D", "25.10.20": "D", "25.10.27": "D", "25.11.03": "D",
    "25.11.10": "D", "25.11.17": "D", "25.11.24": "D", "25.12.01": "S", "25.12.08": "D",
    "25.12.15": "D", "25.12.22": "D", "25.12.29": "N", "26.01.05": "N", "26.01.12": "N",
    "26.01.20": "N", "26.01.26": "D", "26.02.02": "D"
}

def get_snd_mode(target_date):
    sorted_keys = sorted(SND_DB.keys(), reverse=True)
    t_str = target_date.strftime("%y.%m.%d")
    for k in sorted_keys:
        if k <= t_str: return SND_DB[k]
    return "N"

# [3] 3Q í‹°ì–´ë³„ ë…ë¦½ ì‹¤í–‰ ì—”ì§„ (SND íŒŒë¼ë¯¸í„° + í‹°ì–´ë³„ ê°œë³„ ì²­ì‚°)
def run_3q_engine(df, seed, fee, comp_p, comp_l, cycle_d):
    cash = seed
    operating_seed = seed
    history = []
    accumulated_profit = 0
    update_counter = 0

    # ë³´ìœ  í¬ì§€ì…˜ ë¦¬ìŠ¤íŠ¸ (ê° ìš”ì†ŒëŠ” ë”•ì…”ë„ˆë¦¬: {ë§¤ìˆ˜ì¼, ë§¤ìˆ˜ê°€, ìˆ˜ëŸ‰, ëª©í‘œê°€, ë§Œê¸°ì¼})
    positions = []

    # ì´ë¯¸ì§€ íŒŒë¼ë¯¸í„° (ë§¤ìˆ˜%, ë§¤ë„%, MOCì¼ìˆ˜)
    PARAMS = {
        "S": {"buy": 0.04,  "sell": 0.037, "moc": 17},
        "D": {"buy": 0.006, "sell": 0.010, "moc": 25},
        "N": {"buy": 0.05,  "sell": 0.030, "moc": 2}
    }

    for i in range(1, len(df)):
        current_date = df.index[i]
        prev_close = float(df['Close'].iloc[i-1])
        curr_low = float(df['Low'].iloc[i])
        curr_high = float(df['High'].iloc[i])
        curr_close = float(df['Close'].iloc[i])

        mode = get_snd_mode(current_date)
        p = PARAMS.get(mode, PARAMS["N"])

        # --- [1] ë³µë¦¬ ë°˜ì˜ ë¡œì§ (ì£¼ê¸°ë³„ ì‹œë“œ ê°±ì‹ ) ---
        update_counter += 1
        if update_counter >= cycle_d:
            if accumulated_profit > 0:
                operating_seed += (accumulated_profit * comp_p)
            else:
                operating_seed += (accumulated_profit * comp_l)
            accumulated_profit = 0
            update_counter = 0

        # --- [2] ë§¤ë„ ë¡œì§ (ë³´ìœ  ì¤‘ì¸ ëª¨ë“  'ê°œë³„ í‹°ì–´' ê²€ì‚¬) ---
        # ì¤‘ìš”: forë¬¸ì„ ëŒë©´ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •(ì‚­ì œ)í•´ì•¼ í•˜ë¯€ë¡œ ì—­ìˆœ ìˆœíšŒ í˜¹ì€ ìƒˆ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        next_positions = []
        
        for pos in positions:
            is_sold = False
            
            # (A) ê°œë³„ ëª©í‘œê°€ ìµì ˆ ì²´í¬ (Highê°€ ëª©í‘œê°€ ì´ìƒì´ë©´ ìµì ˆ)
            if curr_high >= pos['target_price']:
                sell_val = pos['qty'] * pos['target_price']
                profit = sell_val - (pos['qty'] * pos['buy_price'])
                
                cash += sell_val * (1 - fee)
                accumulated_profit += profit
                is_sold = True
            
            # (B) ê°œë³„ MOC ì²­ì‚° ì²´í¬ (ë³´ìœ ì¼ìˆ˜ >= MOCí•œê³„ì¼ ì´ë©´ ì¢…ê°€ ì²­ì‚°)
            # ì•„ì§ ì•ˆ íŒ”ë ¸ê³ , ì˜¤ëŠ˜ ë‚ ì§œê°€ ë§Œê¸°ì¼(moc_date) ì´í›„ë¼ë©´
            elif not is_sold and (current_date - pos['buy_date']).days >= pos['moc_limit_days']:
                sell_val = pos['qty'] * curr_close
                profit = sell_val - (pos['qty'] * pos['buy_price'])
                
                cash += sell_val * (1 - fee)
                accumulated_profit += profit
                is_sold = True
            
            # (C) ì•ˆ íŒ”ë ¸ìœ¼ë©´ ìœ ì§€
            if not is_sold:
                next_positions.append(pos)
        
        positions = next_positions # ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 

        # --- [3] ë§¤ìˆ˜ ë¡œì§ (ë¹ˆ í‹°ì–´ ì±„ìš°ê¸°) ---
        # "í‹°ì–´ë³„ ë³„ë„ ê³„ì‚°" -> í˜„ì¬ ë³´ìœ  ì¤‘ì¸ í¬ì§€ì…˜ ìˆ˜ = í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í‹°ì–´ ìˆ˜
        # ì˜ˆ: 0ê°œ ë³´ìœ  -> 1í‹°ì–´ ë§¤ìˆ˜, 2ê°œ ë³´ìœ  -> 3í‹°ì–´ ë§¤ìˆ˜
        
        current_tier_index = len(positions) + 1 # í˜„ì¬ ì§„ì…í•  í‹°ì–´ ë²ˆí˜¸
        target_buy_price = prev_close * (1 - p["buy"])

        if curr_low <= target_buy_price and current_tier_index <= 8:
            # 8ë¶„í•  í‹°ì–´ë³„ ë¹„ì¤‘ ê³„ì‚° (ì´ë¯¸ì§€ì™€ ë™ì¼í•œ ë¡œì§ ì ìš©)
            # í†µìƒ 1~4,7í‹°ì–´: 1ìœ ë‹› / 5,6,8í‹°ì–´: ê°€ì¤‘ì¹˜ ë¶€ì—¬
            if current_tier_index in [1, 2, 3, 4, 7]: 
                unit_multiplier = 1.0
            elif current_tier_index == 5: 
                unit_multiplier = 3.6
            elif current_tier_index == 6: 
                unit_multiplier = 3.0
            elif current_tier_index == 8: 
                unit_multiplier = 4.0
            else:
                unit_multiplier = 1.0

            # 1ìœ ë‹› ê¸°ì¤€ ê¸ˆì•¡ = (ìš´ì˜ìê¸ˆ / 8)
            buy_amt = (operating_seed / 8) * unit_multiplier
            buy_qty = int(buy_amt / curr_close)
            if buy_qty < 1: buy_qty = 1 # ìµœì†Œ 1ì£¼

            buy_price = min(target_buy_price, curr_close) # ë§¤ìˆ˜ ì²´ê²°ê°€
            buy_cost = buy_qty * buy_price

            if cash >= buy_cost:
                cash -= buy_cost
                
                # [ì¤‘ìš”] ì‹ ê·œ í¬ì§€ì…˜ ë“±ë¡ (ê°œë³„ ëª©í‘œê°€, MOCì¼ìˆ˜ ê¸°ë¡)
                new_pos = {
                    'buy_date': current_date,
                    'buy_price': buy_price,
                    'qty': buy_qty,
                    'target_price': buy_price * (1 + p["sell"]), # ì§„ì… ì‹œì ì˜ ëª©í‘œê°€ ê³ ì •
                    'moc_limit_days': p["moc"], # ì§„ì… ì‹œì ì˜ MOC ì¼ìˆ˜ ê³ ì •
                    'tier': current_tier_index
                }
                positions.append(new_pos)

        # --- [4] ìì‚° í‰ê°€ ---
        # í˜„ì¬ ì´ ìì‚° = í˜„ê¸ˆ + ë³´ìœ  ì¤‘ì¸ ëª¨ë“  í¬ì§€ì…˜ì˜ í˜„ì¬ê°€ì¹˜ í•©
        equity_val = sum([p['qty'] * curr_close for p in positions])
        total_asset = cash + equity_val
        
        history.append({'Date': current_date, 'Total': total_asset, 'Mode': mode, 'Active_Tiers': len(positions)})
        
    return pd.DataFrame(history)

# [4] ì‚¬ì´ë“œë°” ì‚¬ìš©ì ì…ë ¥ë€
with st.sidebar:
    st.header("ğŸ“‹ ë°±í…ŒìŠ¤íŠ¸ ì„¤ì •")
    ticker = st.text_input("ë¶„ì„ ì¢…ëª© (Ticker)", value="QLD").upper()
    
    min_d, max_d = datetime(2018, 1, 1), datetime(2026, 1, 31)
    col1, col2 = st.columns(2)
    s_date = col1.date_input("ì‹œì‘ì¼", value=datetime(2025, 1, 1), min_value=min_d, max_value=max_d)
    e_date = col2.date_input("ì¢…ë£Œì¼", value=max_d, min_value=min_d, max_value=max_d)
    
    seed = st.number_input("ì´ˆê¸° ì›ê¸ˆ ($)", value=10000, step=1000)
    fee_rate = st.number_input("ê±°ë˜ ìˆ˜ìˆ˜ë£Œ (%)", value=0.0, format="%.3f") / 100
    
    st.divider()
    st.header("ğŸ”„ ë³µë¦¬ ë° ê°±ì‹  ì •ì±…")
    comp_profit = st.slider("ì´ìµ ë³µë¦¬ ë°˜ì˜ ë¹„ìœ¨ (%)", 0, 100, 90) / 100
    comp_loss = st.slider("ì†ì‹¤ ë³µë¦¬ ë°˜ì˜ ë¹„ìœ¨ (%)", 0, 100, 20) / 100
    update_cycle = st.number_input("ë°˜ì˜ ê°±ì‹  ì£¼ê¸° (ì¼)", value=6, min_value=1)
    
    st.success("âœ… 3Q ê°œë³„ í‹°ì–´ ë…ë¦½ ì‹œìŠ¤í…œ ì ìš©ë¨\n(SND ì´ë¯¸ì§€ íŒŒë¼ë¯¸í„° ê¸°ì¤€)")

# [5] ë©”ì¸ í™”ë©´ ì‹¤í–‰ ë° ê²°ê³¼
if st.button("ğŸ“Š 3Q ë…ë¦½ ì—”ì§„ ì‹¤í–‰", type="primary", use_container_width=True):
    with st.spinner("í‹°ì–´ë³„ ê°œë³„ ì¶”ì  ì‹œë®¬ë ˆì´ì…˜ ì¤‘..."):
        df_raw = yf.download(ticker, start=s_date, end=e_date, auto_adjust=True)
        if not df_raw.empty:
            res = run_3q_engine(df_raw, seed, fee_rate, comp_profit, comp_loss, update_cycle)
            
            final_val = res['Total'].iloc[-1]
            st.subheader(f"ğŸ {ticker} ì„±ê³¼ ë¶„ì„ ê²°ê³¼ (Independent Tiers)")
            
            c1, c2, c3, c4 = st.columns(4)
            c1.metric("ìµœì¢… ìì‚°", f"${final_val:,.2f}")
            c2.metric("ì´ ìˆ˜ìµë¥ ", f"{(final_val/seed-1)*100:.2f}%")
            c3.metric("ìµœëŒ€ ìì‚°", f"${res['Total'].max():,.2f}")
            c4.metric("ìµœëŒ€ ë³´ìœ  í‹°ì–´", f"{res['Active_Tiers'].max()} Tier")
            
            st.line_chart(res.set_index('Date')['Total'])
